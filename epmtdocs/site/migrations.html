<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>Database Migrations - EPMT</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="js/jquery-1.10.2.min.js" defer></script>
        <script src="js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href=".">EPMT</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="INSTALL.html" class="nav-link">EPMT Install</a>
                            </li>
                            <li class="navitem">
                                <a href="README.html" class="nav-link">EPMT Readme</a>
                            </li>
                            <li class="navitem active">
                                <a href="migrations.html" class="nav-link">Database Migrations</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Notebooks <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="http://localhost:8888/notebooks/notebooks/Outliers.ipynb" target="_blank" class="dropdown-item">Outliers</a>
</li>
                                    
<li>
    <a href="http://localhost:8888/notebooks/notebooks/Query-API.ipynb" target="_blank" class="dropdown-item">Query API</a>
</li>
                                    
<li>
    <a href="http://localhost:8888/notebooks/notebooks/graphing.ipynb" target="_blank" class="dropdown-item">Graphing API</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="http://localhost:8050" target="_blank" class="nav-link">Interface</a>
                            </li>
                            <li class="navitem">
                                <a href="index_ui.html" class="nav-link">Interface Readme</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <a rel="prev" href="README.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="index_ui.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#database-migrations" class="nav-link">Database Migrations</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#initial-db-setup" class="nav-link">Initial DB setup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="database-migrations">Database Migrations</h1>
<p>Migrations are supported for SQLAlchemy at present. We use
alembic for migrations.</p>
<h3 id="requirements">Requirements</h3>
<ul>
<li>SQLAlchemy ORM</li>
<li>Preferably a database such as Postgres that supports <code>ALTER</code>
   SQLite works, but some migrations will give pain as SQLite 
   doesn't support <code>ALTER</code>.</li>
<li>Persistent database such as in file. We haven't tested
   in-memory configurations.</li>
</ul>
<h1 id="initial-db-setup">Initial DB setup</h1>
<p>We have used alembic's auto-generate feature to create a baseline
migration using the model definitions in <code>orm/sqlalchemy/models.py</code>.</p>
<p>To achieve the automigration, we had to set <code>target_metadata</code> in
<code>migrations/env.py</code>, and then run:</p>
<pre><code>alembic revision --autogenerate -m &quot;baseline&quot;
</code></pre>

<p>This created <code>migrations/versions/392efb1132ae_baseline.py</code>.</p>
<p><code>setup_db</code> checks and applies this baseline migration if the database
is empty.</p>
<p>Once the database is setup, you can apply migrations as explained below.</p>
<h3 id="creating-a-migration">Creating a migration</h3>
<p>Let's follow an example that shows how to add a column
to the users table. We will use an SQLite local-file database.</p>
<pre><code># use the appropriate settings template
$ cp settings/settings_sqlite_localfile_sqlalchemy.py settings.py

# now create a migration file
$ alembic revision -m &quot;add admin column to users table&quot;
Generating
  /home/tushar/mm/epmt/build/epmt/migrations/versions/b1cf8c168491_add_admin_column_to_users_table.py ... done

# Now edit the file, and add the following lines to upgrade and downgrade
# functions in the generated file.
def upgrade():
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('is_admin', sa.Boolean(), nullable=True))


def downgrade():
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_column('is_admin')
</code></pre>

<p>After the migration file has been update, we can run the migration.</p>
<pre><code>$ alembic upgrade head
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -&gt; b1cf8c168491, add admin column to users table
</code></pre>

<p>You can verify the column has been added to the database:</p>
<pre><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        is_admin BOOLEAN, 
        PRIMARY KEY (name), 
        CHECK (is_admin IN (0, 1)), 
        CHECK (is_admin IN (0, 1)), 
        UNIQUE (id)
);
</code></pre>

<p>This only adds the column to the database. If you want to the column to be
accessible in the object model, you WILL need to manually update the model
definition in <code>orm/sqlalchemy/models.py</code>, and add something like:</p>
<pre><code>class User(db.Model):
    ...
    is_admin = db.Column(db.Boolean, default=False)
</code></pre>

<h3 id="to-remove-a-migration">To remove a migration</h3>
<p>To remove the latest migration, simply do:</p>
<pre><code>$ alembic downgrade -1
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running downgrade b1cf8c168491 -&gt; , add admin column to users table
</code></pre>

<p>You can verify the column has been removed:</p>
<pre><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        PRIMARY KEY (name), 
        UNIQUE (id)
);
</code></pre>

<p>To remove all migrations, do:</p>
<pre><code>$ alembic downgrade base
</code></pre>

<h3 id="references">References</h3>
<ul>
<li>https://medium.com/the-andela-way/alembic-how-to-add-a-non-nullable-field-to-a-populated-table-998554003134</li>
<li>https://alembic.sqlalchemy.org/en/latest/batch.html</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js" defer></script>

        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
