


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="favicon.ico">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.6">
    
    
      
        <title>Database Migrations - EPMT</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.4b9ffd7b.min.css">
      
        <link rel="stylesheet" href="assets/stylesheets/palette.b79bcd20.min.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="grey">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-migrations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="." title="EPMT" class="md-header-nav__button md-logo" aria-label="EPMT">
      
  <img src="logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            EPMT
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Database Migrations
            
          </span>
        </div>
      
    </div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="EPMT" class="md-nav__button md-logo" aria-label="EPMT">
      
  <img src="logo.png" alt="logo">

    </a>
    EPMT
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="INSTALL.html" title="EPMT Install" class="md-nav__link">
      EPMT Install
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="README.html" title="EPMT Readme" class="md-nav__link">
      EPMT Readme
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="epmt_cmds.html" title="EPMT Commands" class="md-nav__link">
      EPMT Commands
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Database Migrations
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="migrations.html" title="Database Migrations" class="md-nav__link md-nav__link--active">
      Database Migrations
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Notebooks
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Notebooks" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Notebooks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="http://localhost:8888/notebooks/notebooks/Outliers.ipynb" target="_blank" title="Outliers" class="md-nav__link">
      Outliers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="http://localhost:8888/notebooks/notebooks/Query-API.ipynb" target="_blank" title="Query API" class="md-nav__link">
      Query API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="http://localhost:8888/notebooks/notebooks/graphing.ipynb" target="_blank" title="Graphing API" class="md-nav__link">
      Graphing API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="http://localhost:8050" target="_blank" title="Interface" class="md-nav__link">
      Interface
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="index_ui.html" title="Interface Readme" class="md-nav__link">
      Interface Readme
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="database-migrations">Database Migrations<a class="headerlink" href="#database-migrations" title="Permanent link">&para;</a></h1>
<p>Migrations are supported for SQLAlchemy at present. We use
alembic for migrations.</p>
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h3>
<ul>
<li>SQLAlchemy ORM</li>
<li>Preferably a database such as Postgres that supports <code>ALTER</code>
   SQLite works, but some migrations will give pain as SQLite 
   doesn't support <code>ALTER</code>.</li>
<li>Persistent database such as in file. We haven't tested
   in-memory configurations.</li>
</ul>
<h1 id="initial-db-setup">Initial DB setup<a class="headerlink" href="#initial-db-setup" title="Permanent link">&para;</a></h1>
<p>We have used alembic's auto-generate feature to create a baseline
migration using the model definitions in <code>orm/sqlalchemy/models.py</code>.</p>
<p>To achieve the automigration, we had to set <code>target_metadata</code> in
<code>migrations/env.py</code>, and then run:</p>
<div class="codehilite"><pre><span></span><code>alembic revision --autogenerate -m &quot;baseline&quot;
</code></pre></div>


<p>This created <code>migrations/versions/392efb1132ae_baseline.py</code>.</p>
<p><code>setup_db</code> checks and applies this baseline migration if the database
is empty.</p>
<p>Once the database is setup, you can apply migrations as explained below.</p>
<h3 id="creating-a-migration">Creating a migration<a class="headerlink" href="#creating-a-migration" title="Permanent link">&para;</a></h3>
<p>Let's follow an example that shows how to add a column
to the users table. We will use an SQLite local-file database.</p>
<div class="codehilite"><pre><span></span><code># use the appropriate settings template
$ cp settings/settings_sqlite_localfile_sqlalchemy.py settings.py

# now create a migration file
$ alembic revision -m &quot;add admin column to users table&quot;
Generating
  /home/tushar/mm/epmt/build/epmt/migrations/versions/b1cf8c168491_add_admin_column_to_users_table.py ... done

# Now edit the file, and add the following lines to upgrade and downgrade
# functions in the generated file.
def upgrade():
    with op.batch_alter_table(&#39;users&#39;, schema=None) as batch_op:
        batch_op.add_column(sa.Column(&#39;is_admin&#39;, sa.Boolean(), nullable=True))


def downgrade():
    with op.batch_alter_table(&#39;users&#39;, schema=None) as batch_op:
        batch_op.drop_column(&#39;is_admin&#39;)
</code></pre></div>


<p>After the migration file has been update, we can run the migration.</p>
<div class="codehilite"><pre><span></span><code>$ alembic upgrade head
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -&gt; b1cf8c168491, add admin column to users table
</code></pre></div>


<p>You can verify the column has been added to the database:</p>
<div class="codehilite"><pre><span></span><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        is_admin BOOLEAN, 
        PRIMARY KEY (name), 
        CHECK (is_admin IN (0, 1)), 
        CHECK (is_admin IN (0, 1)), 
        UNIQUE (id)
);
</code></pre></div>


<p>This only adds the column to the database. If you want to the column to be
accessible in the object model, you WILL need to manually update the model
definition in <code>orm/sqlalchemy/models.py</code>, and add something like:</p>
<div class="codehilite"><pre><span></span><code>class User(db.Model):
    ...
    is_admin = db.Column(db.Boolean, default=False)
</code></pre></div>


<h3 id="to-remove-a-migration">To remove a migration<a class="headerlink" href="#to-remove-a-migration" title="Permanent link">&para;</a></h3>
<p>To remove the latest migration, simply do:</p>
<div class="codehilite"><pre><span></span><code>$ alembic downgrade -1
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running downgrade b1cf8c168491 -&gt; , add admin column to users table
</code></pre></div>


<p>You can verify the column has been removed:</p>
<div class="codehilite"><pre><span></span><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        PRIMARY KEY (name), 
        UNIQUE (id)
);
</code></pre></div>


<p>To remove all migrations, do:</p>
<div class="codehilite"><pre><span></span><code>$ alembic downgrade base
</code></pre></div>


<h3 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h3>
<ul>
<li>https://medium.com/the-andela-way/alembic-how-to-add-a-non-nullable-field-to-a-populated-table-998554003134</li>
<li>https://alembic.sqlalchemy.org/en/latest/batch.html</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="epmt_cmds.html" title="EPMT Commands" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                EPMT Commands
              </div>
            </div>
          </a>
        
        
          <a href="index_ui.html" title="Interface Readme" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Interface Readme
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/vendor.a0c4167b.min.js"></script>
      <script src="assets/javascripts/bundle.fb26dd1d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: ".",
          features: [],
          search: Object.assign({
            worker: "assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>