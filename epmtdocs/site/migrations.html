<!DOCTYPE html>
<html lang="en">
    <head>
      <script>
	// Hack for scrolling window when linking to anchor tag with fixed nav header
        var shiftWindow = function() { scrollBy(0, -75) };
        window.addEventListener("hashchange", shiftWindow);
        function load() { if (window.location.hash) shiftWindow(); }
      </script>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="./img/favicon.ico">
        <title>Database Migrations - EPMT</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="js/base.js"></script> 
    </head>

    <body class="">

      <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
	<div class="container">
	<a class="navbar-brand" href="README.html">EPMT</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse">
          <!-- Main navigation -->
          <nav class="nav">
            <ul class="navbar-nav">
              <li >
                <a class="nav-link" href="INSTALL.html">Install</a>
              </li>
              <li >
                <a class="nav-link" href="README.html">Readme</a>
              </li>
              <li class="active">
                <a class="nav-link" href="migrations.html">Database Migrations</a>
              </li>
              <li class="nav-item dropdown">
                <a href="#" role="button" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="nav-dropdown-Notebooks">Notebooks <b class="caret"></b></a>
                <div class="dropdown-menu" aria-labelledby="nav-dropdown-Notebooks">
                  
<a href="http://localhost:8888/notebooks/notebooks/Outliers.ipynb" target="_blank" class="dropdown-item">Outliers</a>
                  
<a href="http://localhost:8888/notebooks/notebooks/Query-API.ipynb" target="_blank" class="dropdown-item">Query API</a>
                </div>
              </li>
              <li >
                <a class="nav-link" href="http://localhost:8050" target="_blank">Interface</a>
              </li>
              <li >
                <a class="nav-link" href="index_ui.html">Interface Readme</a>
              </li>
            </ul>
          </nav>

          <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
            <li class="nav-item">
              <a class="nav-link" rel="next" href="README.html">
		<i class="fa fa-arrow-left"></i> Previous
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" rel="prev" href="index_ui.html">
		Next <i class="fa fa-arrow-right"></i>
              </a>
            </li>
          </ul>
	</div>
	</div>
      </nav><div id="content" class="container">
        
      <div class="row">
        <div class="col-md-9" role="main">


<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    
    <li class="breadcrumb-item active" aria-current="page">Database Migrations</li>
  </ol>
</nav>


<h1 id="database-migrations">Database Migrations</h1>
<p>Migrations are supported for SQLAlchemy at present. We use
alembic for migrations.</p>
<h3 id="requirements">Requirements</h3>
<ul>
<li>SQLAlchemy ORM</li>
<li>Preferably a database such as Postgres that supports <code>ALTER</code>
   SQLite works, but some migrations will give pain as SQLite 
   doesn't support <code>ALTER</code>.</li>
<li>Persistent database such as in file. We haven't tested
   in-memory configurations.</li>
</ul>
<h1 id="initial-db-setup">Initial DB setup</h1>
<p>We have used alembic's auto-generate feature to create a baseline
migration using the model definitions in <code>orm/sqlalchemy/models.py</code>.</p>
<p>To achieve the automigration, we had to set <code>target_metadata</code> in
<code>migrations/env.py</code>, and then run:</p>
<pre><code>alembic revision --autogenerate -m &quot;baseline&quot;
</code></pre>

<p>This created <code>migrations/versions/392efb1132ae_baseline.py</code>.</p>
<p><code>setup_db</code> checks and applies this baseline migration if the database
is empty.</p>
<p>Once the database is setup, you can apply migrations as explained below.</p>
<h3 id="creating-a-migration">Creating a migration</h3>
<p>Let's follow an example that shows how to add a column
to the users table. We will use an SQLite local-file database.</p>
<pre><code># use the appropriate settings template
$ cp settings/settings_sqlite_localfile_sqlalchemy.py settings.py

# now create a migration file
$ alembic revision -m &quot;add admin column to users table&quot;
Generating
  /home/tushar/mm/epmt/build/epmt/migrations/versions/b1cf8c168491_add_admin_column_to_users_table.py ... done

# Now edit the file, and add the following lines to upgrade and downgrade
# functions in the generated file.
def upgrade():
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('is_admin', sa.Boolean(), nullable=True))


def downgrade():
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_column('is_admin')
</code></pre>

<p>After the migration file has been update, we can run the migration.</p>
<pre><code>$ alembic upgrade head
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -&gt; b1cf8c168491, add admin column to users table
</code></pre>

<p>You can verify the column has been added to the database:</p>
<pre><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        is_admin BOOLEAN, 
        PRIMARY KEY (name), 
        CHECK (is_admin IN (0, 1)), 
        CHECK (is_admin IN (0, 1)), 
        UNIQUE (id)
);
</code></pre>

<p>This only adds the column to the database. If you want to the column to be
accessible in the object model, you WILL need to manually update the model
definition in <code>orm/sqlalchemy/models.py</code>, and add something like:</p>
<pre><code>class User(db.Model):
    ...
    is_admin = db.Column(db.Boolean, default=False)
</code></pre>

<h3 id="to-remove-a-migration">To remove a migration</h3>
<p>To remove the latest migration, simply do:</p>
<pre><code>$ alembic downgrade -1
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running downgrade b1cf8c168491 -&gt; , add admin column to users table
</code></pre>

<p>You can verify the column has been removed:</p>
<pre><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        PRIMARY KEY (name), 
        UNIQUE (id)
);
</code></pre>

<p>To remove all migrations, do:</p>
<pre><code>$ alembic downgrade base
</code></pre>

<h3 id="references">References</h3>
<ul>
<li>https://medium.com/the-andela-way/alembic-how-to-add-a-non-nullable-field-to-a-populated-table-998554003134</li>
<li>https://alembic.sqlalchemy.org/en/latest/batch.html</li>
</ul>

<ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
  <li class="last-updated-holder displayDate loading">
    <span class="last-updated-text">Last updated:</span>
    <time role="presentation" datetime="2018-10-25T00:00:00.000Z" data-article-date-source="ms.date"></time>
  </li>
<!--
  <li class="readingTime">
    2 minutes to read
  </li>
-->
  <li class="contributors-holder">
    <span class="contributors-text">Contributors</span>
    <ul class="contributors" data-bi-name="contributors"></ul>
  </li>
</ul>
</div>
        <div class="col-md-3"><div class="navbar-light navbar-expand-md hidden-print sticky-top sticky-offset" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    <div id="toc-collapse" class="navbar-collapse collapse card">
        <ul class="nav flex-column bs-sidenav">
            <li class="nav-item main"><a class="nav-link" href="#database-migrations">Database Migrations</a></li>
                <li class="nav-item">
                    <a href="#requirements" class="nav-link">Requirements</a>
                </li>
            <li class="nav-item main"><a class="nav-link" href="#initial-db-setup">Initial DB setup</a></li>
                <li class="nav-item">
                    <a href="#creating-a-migration" class="nav-link">Creating a migration</a>
                </li>
                <li class="nav-item">
                    <a href="#to-remove-a-migration" class="nav-link">To remove a migration</a>
                </li>
                <li class="nav-item">
                    <a href="#references" class="nav-link">References</a>
                </li>
        </ul>
    </div>
</div></div>
      </div>
      </div>

      <footer class="col-md-12">
	<hr>
	<div class="container">
	</div>
      </footer>
      <script>
	var base_url = ".",
            shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
      </script>
      <script src="js/base.js" defer></script>

      <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <p class="h4 modal-title">Keyboard Shortcuts</p>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
