<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Database Migrations - My Docs</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">My Docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../README.md">Home</a>
                            </li>
                            <li >
                                <a href="../INSTALL/">EPMT Installation</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Notebooks <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="http://localhost:8888/notebooks/notebooks/Outliers.ipynb" target="_blank">Outliers</a>
</li>
                                    
<li >
    <a href="http://localhost:8888/notebooks/notebooks/Query-API.ipynb" target="_blank">Query API</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="http://localhost:8050" target="_blank">Interface</a>
                            </li>
                            <li >
                                <a href="../index_ui/">Interface Readme</a>
                            </li>
                            <li class="active">
                                <a href="./">Database Migrations</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../index_ui/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="disabled">
                                <a rel="prev" >
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#database-migrations">Database Migrations</a></li>
            <li><a href="#requirements">Requirements</a></li>
        <li class="main "><a href="#initial-db-setup">Initial DB setup</a></li>
            <li><a href="#creating-a-migration">Creating a migration</a></li>
            <li><a href="#to-remove-a-migration">To remove a migration</a></li>
            <li><a href="#references">References</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="database-migrations">Database Migrations</h1>
<p>Migrations are supported for SQLAlchemy at present. We use
alembic for migrations.</p>
<h3 id="requirements">Requirements</h3>
<ul>
<li>SQLAlchemy ORM</li>
<li>Preferably a database such as Postgres that supports <code>ALTER</code>
   SQLite works, but some migrations will give pain as SQLite 
   doesn't support <code>ALTER</code>.</li>
<li>Persistent database such as in file. We haven't tested
   in-memory configurations.</li>
</ul>
<h1 id="initial-db-setup">Initial DB setup</h1>
<p>We have used alembic's auto-generate feature to create a baseline
migration using the model definitions in <code>orm/sqlalchemy/models.py</code>.</p>
<p>To achieve the automigration, we had to set <code>target_metadata</code> in
<code>migrations/env.py</code>, and then run:</p>
<pre><code>alembic revision --autogenerate -m &quot;baseline&quot;
</code></pre>

<p>This created <code>migrations/versions/392efb1132ae_baseline.py</code>.</p>
<p><code>setup_db</code> checks and applies this baseline migration if the database
is empty.</p>
<p>Once the database is setup, you can apply migrations as explained below.</p>
<h3 id="creating-a-migration">Creating a migration</h3>
<p>Let's follow an example that shows how to add a column
to the users table. We will use an SQLite local-file database.</p>
<pre><code># use the appropriate settings template
$ cp settings/settings_sqlite_localfile_sqlalchemy.py settings.py

# now create a migration file
$ alembic revision -m &quot;add admin column to users table&quot;
Generating
  /home/tushar/mm/epmt/build/epmt/migrations/versions/b1cf8c168491_add_admin_column_to_users_table.py ... done

# Now edit the file, and add the following lines to upgrade and downgrade
# functions in the generated file.
def upgrade():
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('is_admin', sa.Boolean(), nullable=True))


def downgrade():
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_column('is_admin')
</code></pre>

<p>After the migration file has been update, we can run the migration.</p>
<pre><code>$ alembic upgrade head
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -&gt; b1cf8c168491, add admin column to users table
</code></pre>

<p>You can verify the column has been added to the database:</p>
<pre><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        is_admin BOOLEAN, 
        PRIMARY KEY (name), 
        CHECK (is_admin IN (0, 1)), 
        CHECK (is_admin IN (0, 1)), 
        UNIQUE (id)
);
</code></pre>

<p>This only adds the column to the database. If you want to the column to be
accessible in the object model, you WILL need to manually update the model
definition in <code>orm/sqlalchemy/models.py</code>, and add something like:</p>
<pre><code>class User(db.Model):
    ...
    is_admin = db.Column(db.Boolean, default=False)
</code></pre>

<h3 id="to-remove-a-migration">To remove a migration</h3>
<p>To remove the latest migration, simply do:</p>
<pre><code>$ alembic downgrade -1
INFO  [alembic.runtime.migration] Using sqlite:///db.sqlite
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running downgrade b1cf8c168491 -&gt; , add admin column to users table
</code></pre>

<p>You can verify the column has been removed:</p>
<pre><code>$ echo &quot;.schema users&quot; | sqlite3 db.sqlite
CREATE TABLE &quot;users&quot; (
        created_at DATETIME, 
        updated_at DATETIME, 
        name VARCHAR NOT NULL, 
        id INTEGER, 
        info_dict JSON, 
        PRIMARY KEY (name), 
        UNIQUE (id)
);
</code></pre>

<p>To remove all migrations, do:</p>
<pre><code>$ alembic downgrade base
</code></pre>

<h3 id="references">References</h3>
<ul>
<li>https://medium.com/the-andela-way/alembic-how-to-add-a-non-nullable-field-to-a-populated-table-998554003134</li>
<li>https://alembic.sqlalchemy.org/en/latest/batch.html</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
